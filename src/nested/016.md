# **Module 16: Automated Data Quality Assessment for Soil Samples**

Build ML-based anomaly detection to identify mislabeled samples, contamination, and analytical errors. Implement statistical process control for laboratory data streams.

The course objective is to build an intelligent "immune system" for a soil data platform. Students will implement automated pipelines that use both classical Statistical Process Control (SPC) and modern Machine Learning-based anomaly detection to identify a wide range of data quality issues, including mislabeled samples, instrument drift, contamination, and analytical errors. The goal is to ensure that only high-quality, trustworthy data is propagated to the foundation models.

This module is the quality gatekeeper of the **Foundation Phase**. It operationalizes the uncertainty concepts from Module 9 and acts directly on the data streams from Module 11 and the data lake from Module 15. A robust, automated DQ system is non-negotiable for building trustworthy foundation models. The ability to automatically flag and quarantine suspicious data is essential for maintaining the integrity of the entire "Global Soil Data Commons" and preventing the "garbage in, garbage out" problem at a petabyte scale.

---

### **Hour 1-2: The "Garbage In, Garbage Out" Imperative** üóëÔ∏è

**Learning Objectives:**
* Understand the profound impact of poor data quality on scientific conclusions and model performance.
* Categorize the common types of errors found in soil sample data.
* Differentiate between data validation, data verification, and data quality assessment.

**Content:**
* **Why Data Quality is Paramount**: We'll start with a motivating disaster story: how a single mislabeled soil sample (e.g., an organic-rich Histosol labeled as a mineral-rich Mollisol) can corrupt an entire spectral calibration model, leading to wildly incorrect predictions for thousands of other samples.
* **A Taxonomy of Soil Data Errors**:
    * **Gross Errors**: Sample swaps in the lab, incorrect sample ID entry, catastrophic instrument failure.
    * **Systematic Errors**: Persistent instrument miscalibration, consistent procedural errors by a technician, sensor drift.
    * **Random Errors**: The natural, unavoidable noise in any measurement process.
* **The Need for Automation**: Manually inspecting thousands of daily data points is impossible. We need an automated, systematic approach to data quality that can operate at the scale of our data lakehouse.

**Discussion Exercise:**
* Review the data generation processes from previous modules (LIMS, sensors, spectroscopy, legacy data).
* For each process, brainstorm and list at least three potential sources of data quality errors.
* Discuss which types of errors would be easiest and hardest to detect automatically.

---

### **Hour 3-4: Statistical Process Control (SPC) for Laboratory Streams** üìà

**Learning Objectives:**
* Understand the principles of SPC and its application to laboratory data.
* Implement Shewhart control charts (I-MR charts) to monitor lab standards.
* Interpret control chart rules to distinguish between normal variation and a process that is "out of control."

**Content:**
* **From the Factory Floor to the Soil Lab**: SPC was developed to monitor manufacturing processes, but its principles are perfectly suited for a high-throughput soil lab. The goal: detect problems *as they happen*.
* **The Voice of the Process**: A control chart helps us understand the natural, "common cause" variation of a stable process.
* **Shewhart Charts for Lab Control Samples**: We will focus on the **Individuals and Moving Range (I-MR)** chart, which is ideal for tracking the measurement of a Certified Reference Material (CRM) or a lab control sample over time.
* **Detecting Trouble**: We will implement the **Western Electric Rules** (or similar rule sets) to automatically flag out-of-control conditions, such as a single point outside the ¬±3œÉ limits or eight consecutive points on one side of the mean, which indicates a process shift.

**Hands-on Lab:**
* You are given a time-series dataset from a LIMS showing the daily measured phosphorus value for a stable lab control sample.
* Using a Python library like `spc` or `pandas`, you will:
    1.  Create an I-MR control chart.
    2.  Calculate the center line (mean) and the upper and lower control limits.
    3.  Write a function to apply a set of control chart rules to the data.
    4.  Generate a plot that visualizes the control chart and highlights the out-of-control points.

---

### **Hour 5-6: Unsupervised Anomaly Detection I: Finding Univariate Outliers** üéØ

**Learning Objectives:**
* Implement robust statistical methods for detecting outliers in a single variable.
* Understand the strengths and weaknesses of different univariate methods.
* Apply pedological rules to validate data plausibility.

**Content:**
* **Beyond Known Standards**: SPC is great for CRMs, but how do we find errors in the unknown samples that make up the bulk of our data? We start by looking for values that are unusual on their own.
* **The Statistical Toolkit**:
    * **Z-Score**: Simple and effective, but sensitive to the very outliers it's trying to find.
    * **Modified Z-Score**: Uses the median instead of the mean, making it much more robust.
    * **Interquartile Range (IQR) Method**: A non-parametric method that is also highly robust to extreme values.
* **Sanity-Checking with Domain Knowledge**: The most powerful first line of defense is often a set of simple rules based on soil science, for example:
    * `(sand % + silt % + clay %) must be between 98 and 102.`
    * `pH must be between 2 and 11.`
    * `Bulk density cannot be greater than 2.65 g/cm¬≥.`

**Data Cleaning Lab:**
* Given a large soil dataset, write a Python script that:
    1.  Applies the Modified Z-score and IQR methods to flag potential outliers in at least three key properties (e.g., pH, CEC, organic carbon).
    2.  Implements a function that applies at least three pedological validation rules.
    3.  Generates a "data quality report" DataFrame that lists each sample ID and the specific quality checks it failed.

---

### **Hour 7-8: Unsupervised Anomaly Detection II: Finding Multivariate Anomalies** üß¨

**Learning Objectives:**
* Understand why multivariate methods are essential for finding "unusual combinations" of values.
* Implement both proximity-based and tree-based unsupervised anomaly detection algorithms.
* Visualize high-dimensional anomalies using dimensionality reduction.

**Content:**
* **The Contextual Anomaly**: A single value might be normal, but its combination with other values is not. **Example**: A soil with 80% clay content is plausible. A soil with a cation exchange capacity (CEC) of 5 cmol/kg is also plausible. But a soil with 80% clay and a CEC of 5 is a major anomaly that univariate methods will miss.
* **The Machine Learning Toolkit (`scikit-learn`)**:
    * **Isolation Forest**: A fast and efficient algorithm that works by building random trees. Anomalies are points that are easier to "isolate" from the rest of the data.
    * **Local Outlier Factor (LOF)**: A density-based method that identifies anomalies by comparing a point's local density to the densities of its neighbors.
* **Visualizing the Anomalies**: Using techniques like Principal Component Analysis (PCA) to project the high-dimensional data into 2D and color-code the points flagged as anomalies to see if they form distinct clusters.

**Machine Learning Lab:**
* Using the same soil dataset, apply the **Isolation Forest** algorithm from `scikit-learn` to a set of 5-10 chemical properties.
* Generate a list of the top 1% most anomalous samples as identified by the model.
* For the top 5 anomalies, print out their full chemical profiles and write a short interpretation of *why* the model likely flagged them as having an unusual combination of properties.

---

### **Hour 9-10: Domain-Specific Anomaly Detection: Spectra, Time Series & Maps** üõ∞Ô∏è

**Learning Objectives:**
* Develop specialized anomaly detection techniques for the unique data types in soil science.
* Build a neural network autoencoder to detect anomalous soil spectra.
* Apply anomaly detection methods to time-series and geospatial data.

**Content:**
* **No One-Size-Fits-All Solution**: The best DQ checks are tailored to the data's structure.
* **Anomalous Spectra (Module 4)**: A "bad" spectrum might have a massive spike, a strange baseline, or be saturated. An **autoencoder** is a neural network trained to compress and then reconstruct its input. When trained only on "good" spectra, it will have a high reconstruction error for anomalous ones, making it an excellent anomaly detector.
* **Anomalous Time Series (Module 7)**: Detecting sudden spikes, level shifts, or changes in variance in sensor data streams using algorithms designed for sequential data.
* **Anomalous Spatial Data (Module 6)**: Finding a "spatial outlier"‚Äîa location whose value is wildly different from all of its geographic neighbors.

**Deep Learning Lab:**
* Using TensorFlow or PyTorch, build and train a simple autoencoder on a dataset of soil MIR spectra.
* Create a function that calculates the mean squared reconstruction error for any new spectrum fed through the trained model.
* Test the function on a mix of "good" spectra and artificially created "bad" spectra (e.g., with a large spike added).
* Use the reconstruction error as an anomaly score to flag the bad spectra.

---

### **Hour 11-12: Supervised Methods: Learning from Past Mistakes** üß†

**Learning Objectives:**
* Frame data quality checking as a supervised machine learning problem when labels are available.
* Implement techniques to handle the severe class imbalance inherent in anomaly detection.
* Build a classifier to predict if a sample is likely erroneous based on historical data.

**Content:**
* **Using Labeled Data**: Often, a lab will have historical records of known errors (e.g., "this batch was contaminated," "this instrument was miscalibrated"). This labeled data is gold.
* **The Imbalance Problem**: In any DQ dataset, 99.9% of samples will be "normal" and 0.1% will be "anomalous." Standard classifiers will fail, achieving high accuracy by simply predicting "normal" every time.
* **Techniques for Imbalanced Learning**:
    * **Resampling**: SMOTE (Synthetic Minority Over-sampling TEchnique) to create more examples of the rare class.
    * **Algorithmic**: Using models with `class_weight` parameters (like Random Forest, SVM) to penalize misclassifications of the minority class more heavily.
* **Choosing the Right Metrics**: Accuracy is useless. We will focus on **Precision, Recall, F1-Score**, and the **AUC-PR** (Area Under the Precision-Recall Curve).

**Classification Lab:**
* You are given a soil dataset with a small number of samples pre-labeled as "error."
* Train a Gradient Boosting classifier (like LightGBM or XGBoost) on this data.
* Implement both SMOTE and class weighting to handle the imbalance.
* Evaluate the models using a Precision-Recall curve and select the best-performing model based on its F1-score.

---

### **Hour 13-14: Building a Production Data Quality Pipeline** üè≠

**Learning Objectives:**
* Design a multi-stage, automated data quality pipeline architecture.
* Integrate DQ checks into a version-controlled workflow (DVC).
* Create a "human-in-the-loop" feedback system for continuous improvement.

**Content:**
* **The Automated DQ Architecture**:
    1.  **Ingestion**: New data arrives in the data lake's "landing" zone.
    2.  **DQ Job**: A scheduled Kubernetes Job triggers a containerized application that runs a suite of DQ checks.
    3.  **The Suite**: The job runs SPC, univariate checks, an Isolation Forest model, and the spectral autoencoder in sequence.
    4.  **Tag & Route**: Each row/sample is enriched with a JSON column containing DQ flags. Based on the severity of the flags, the entire record is routed to one of three locations: a `clean` table, a `quarantine` table, or a `rejected` table.
* **The Feedback Loop**: Data in the `quarantine` table is surfaced to a data steward via a dashboard. The steward's decision ("this is a real error" or "this is a valid but unusual sample") is logged and used as new labeled data to retrain the supervised models.

**Pipeline Engineering Sprint:**
* Using the DVC framework from Module 8, create a `dvc.yaml` that defines a two-stage pipeline.
* **Stage 1 (`generate_data`)**: A script that produces a new batch of messy data.
* **Stage 2 (`run_dq_checks`)**: A Python script that takes the raw data as input. It runs at least two of the DQ methods learned in this course. It produces two outputs: `clean_data.csv` and `quarantined_data.csv`.
* Run `dvc repro` to execute the full pipeline.

---

### **Hour 15: Capstone: The Automated Daily Data Audit System** üèÜ

**Final Challenge:**
You are the lead MLOps engineer responsible for the integrity of a national soil data repository. Every day, you receive a batch of data from dozens of collaborating labs. Your task is to build the automated system that audits this data and decides whether to accept it.

**The Mission:**
You will build a Python application that simulates the daily audit for an incoming batch of data. The data includes both unknown samples and measurements of a Certified Reference Material (CRM).

**The Audit Pipeline Must:**
1.  **Check for Process Stability (SPC)**: First, analyze the new CRM measurement. If it causes the lab's SPC chart to go into an "out-of-control" state, the *entire batch* is immediately flagged for quarantine, and no further checks are run.
2.  **Find Univariate Errors**: If the process is stable, apply robust (Modified Z-score) checks to all numerical columns in the unknown sample data.
3.  **Find Multivariate Anomalies**: Apply a pre-trained Isolation Forest model to the data to find unusual combinations of properties.
4.  **Generate a Quality Report**: The final output must be a single, clear markdown report that includes:
    * The status of the SPC check (e.g., "PASS: CRM within control limits").
    * A table listing any samples that failed univariate checks and which rules they violated.
    * A table listing the top 5 most anomalous samples identified by the Isolation Forest model.
    * A final, automated recommendation: **"ACCEPT"**, **"ACCEPT_WITH_WARNINGS"** (if some anomalies are found), or **"QUARANTINE"** (if the SPC check fails).

**Deliverables:**
* A complete, documented Python script that implements the entire audit pipeline.
* The generated markdown report for a sample input batch.
* A short, reflective essay on how you would implement the "human-in-the-loop" feedback mechanism and use the quarantined data to make the ML-based checks more intelligent over time.

**Assessment Criteria:**
* The logical correctness and robustness of the multi-stage audit pipeline.
* The correct application of both SPC and unsupervised ML techniques.
* The clarity, conciseness, and actionability of the final generated report.
* The strategic thinking demonstrated in the essay on continuous improvement.