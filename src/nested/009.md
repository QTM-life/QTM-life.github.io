# **Module 9: Uncertainty Quantification in Soil Measurements**

Build probabilistic frameworks to propagate measurement uncertainty through model pipelines. Handle detection limits, censored data, and inter-laboratory variation in soil analyses.

The course objective is to build robust probabilistic frameworks for quantifying and propagating uncertainty throughout the entire soil data lifecycle. Students will master the statistical and computational techniques required to handle the inherent uncertainty in soil measurements, including inter-laboratory variation, censored data (detection limits), and sampling error, producing analysis-ready datasets where every value is a probability distribution, not a single number.

This module provides the statistical foundation for scientific integrity across the entire curriculum. It moves beyond the simple "missing values" of Module 1 to a formal treatment of "unknown values." It builds upon the version-controlled pipelines from Module 8 by teaching how to manage probabilistic, rather than deterministic, data artifacts. The uncertainty distributions generated here are the essential inputs for advanced models like **Ensemble Methods** (Module 61) and **Bayesian Neural Networks** (Module 74), enabling them to produce trustworthy predictions with confidence intervals.

---

### **Hour 1-2: The Certainty of Uncertainty: A Paradigm Shift** ü§î

**Learning Objectives:**
* Articulate why representing a soil property as a single number is insufficient and often misleading.
* Differentiate between accuracy, precision, and the sources of error in soil analysis.
* Understand the real-world consequences of ignoring uncertainty in applications like carbon markets and environmental regulation.

**Content:**
* **Beyond the Mean**: Shifting from a deterministic mindset (SOC is 2.1%) to a probabilistic one (SOC is likely between 1.9% and 2.3%).
* **A Taxonomy of Error**:
    * **Systematic Error (Bias)**: Consistent, repeatable error (e.g., a miscalibrated instrument).
    * **Random Error (Noise)**: Unpredictable fluctuations (e.g., electronic noise, minor variations in pipetting).
* **The Error Budget**: Deconstructing the total uncertainty of a final value (e.g., Mg C/ha) into its constituent sources: field sampling, subsampling, lab analysis, and calculation. Which part contributes the most? (Hint: It's almost always sampling).
* **Case Study**: How failing to account for uncertainty in soil carbon measurements can make a carbon sequestration project appear successful when it's statistically indistinguishable from zero change.

**Practical Exercise:**
* Given a set of replicate measurements for a single soil sample, use Python's `numpy` and `matplotlib` to calculate the mean, standard deviation, and standard error.
* Plot a histogram of the replicates and overlay a fitted normal distribution curve to visualize the measurement's probability distribution.
* Discuss: What does the width of this distribution tell us about the measurement's precision?

---

### **Hour 3-4: Representing Uncertainty: From Numbers to Distributions** üé≤

**Learning Objectives:**
* Represent a single measurement as a probability distribution object.
* Select appropriate probability distributions for different soil properties.
* Generate random samples from these distributions to represent the range of plausible true values.

**Content:**
* **The Measurement as a Distribution**: A measurement of "10.5 ¬± 0.8" is shorthand for a Gaussian distribution with a mean of 10.5 and a standard deviation of 0.8.
* **The Distribution Toolkit**:
    * **Normal (Gaussian)**: Good for many chemical measurements that are far from zero.
    * **Log-Normal**: Essential for properties that cannot be negative and are often skewed (e.g., trace element concentrations, hydraulic conductivity).
    * **Uniform**: Represents a value known to be within a range but with no other information (e.g., a manufacturer's tolerance).
* **The Power of Sampling**: Using code to draw thousands of random samples from a measurement's distribution. This collection of samples *is* our representation of the uncertain value.

**Hands-on Lab:**
* Use Python's `scipy.stats` library to create distribution objects for several soil measurements (e.g., pH as Normal, lead concentration as Log-Normal).
* For each measurement, draw 10,000 random samples.
* Plot the histograms of these samples to visually confirm they match the intended distributions.
* Store these arrays of samples; they will be the inputs for the next lab.

---

### **Hour 5-6: Error Propagation via Monte Carlo Simulation** üé∞

**Learning Objectives:**
* Understand the principles of Monte Carlo error propagation.
* Implement a Monte Carlo simulation to propagate uncertainty through a mathematical formula.
* Calculate the final value and its uncertainty from the simulation results.

**Content:**
* **Why Analytical Error Propagation is Hard**: The traditional "rules" for propagating error are complex and only work for simple equations.
* **The Monte Carlo Alternative (The "Guesstimate" Method)**: A brilliantly simple and powerful technique:
    1.  Represent each input variable as an array of random samples (from the previous lab).
    2.  Apply your calculation to these arrays, element by element.
    3.  The result is a new array of samples that represents the probability distribution of your final answer.
* **Summarizing the Output**: The mean of the output array is your best estimate, and the standard deviation is its uncertainty.

**Technical Workshop:**
* **Goal**: Calculate the uncertainty of a soil carbon stock (in Mg/ha).
* **Inputs**: You are given the mean and standard deviation for three uncertain measurements:
    1.  Bulk Density (g/cm¬≥)
    2.  Soil Organic Carbon concentration (%)
    3.  Horizon Depth (cm)
* **Task**:
    1.  Represent each input as an array of 100,000 random samples.
    2.  Write the formula for carbon stock, applying it to your sample arrays.
    3.  Plot a histogram of the resulting carbon stock distribution.
    4.  Report the final carbon stock as `mean ¬± standard deviation`.

---

### **Hour 7-8: The Elephant in the Lab: Handling Censored Data** üìâ

**Learning Objectives:**
* Understand why values reported as "Below Detection Limit" (BDL) are a form of censored data.
* Recognize why common substitution methods (using 0, DL/2, or DL) are statistically invalid and introduce bias.
* Implement robust methods for handling censored data.

**Content:**
* **What BDL Really Means**: It's not a value of zero. It's an *un-measured value* that is known to be somewhere between 0 and the detection limit.
* **Why Substitution is Wrong**: We'll demonstrate how substituting a single value systematically biases the mean and underestimates the true variance of the dataset.
* **Correct Approaches**:
    * **Maximum Likelihood Estimation (MLE)**: A statistical method that finds the parameters of a distribution (e.g., the mean and variance) that are most likely to have produced the observed data, including the censored values.
    * **Regression on Order Statistics (ROS)**: A practical method that fits a distribution to the detected values and uses it to impute plausible values for the BDLs.

**Hands-on Lab:**
* Use the Python library `NADA` (Nondetects And Data Analysis) which is designed for this problem.
* Take a dataset of trace metal concentrations containing BDL values.
* First, calculate the mean and variance using the three incorrect substitution methods.
* Then, use ROS to estimate the mean and variance correctly.
* Compare the results and quantify the bias introduced by the naive methods.

---

### **Hour 9-10: Taming the Beast: Inter-Laboratory Variation** üè¢

**Learning Objectives:**
* Analyze data from laboratory ring trials to quantify inter-lab bias and precision.
* Implement a random effects model to synthesize data from multiple labs.
* Generate a "consensus value" and uncertainty for a property measured by different sources.

**Content:**
* **The Multi-Lab Problem**: Lab A consistently reads 5% higher than Lab B. How do you combine their datasets?
* **Ring Trials**: The gold standard for assessing lab performance, where a homogenized sample is sent to many labs for analysis.
* **Modeling the Variation**:
    * **Fixed Effects**: The (incorrect) assumption that all labs are measuring the same "true" value, and differences are just random noise.
    * **Random Effects Model**: The correct approach, which models the overall mean value, the variance *within* each lab, and the variance *between* labs. This explicitly accounts for systematic bias.

**Statistical Modeling Lab:**
* Given a dataset from a ring trial (e.g., 20 labs measuring pH on the same soil sample).
* Use Python's `statsmodels` library to fit a random effects model.
* Extract the key outputs:
    1.  The estimated overall mean pH (the consensus value).
    2.  The within-lab variance component.
    3.  The between-lab variance component.
* Discuss the implications: If the between-lab variance is large, it means lab choice is a major source of uncertainty.

---

### **Hour 11-12: Probabilistic Data Structures & Pipelines** üèóÔ∏è

**Learning Objectives:**
* Design data schemas and file formats to store probabilistic data.
* Modify a DVC pipeline to track and process uncertain data.
* Understand the trade-offs between storing full distributions vs. parametric representations.

**Content:**
* **Storing Uncertainty**:
    * **Parametric**: Store the distribution parameters (e.g., `mean`, `stdev`, `distribution_type`) in database columns or a CSV. (Efficient, but loses some info).
    * **Ensemble**: Store the full array of Monte Carlo samples for each measurement. (Complete, but uses much more storage). A common format is NetCDF or HDF5.
* **DVC for Probabilistic Workflows**:
    * The output of a processing step is no longer a single `data.csv`.
    * The output is now a directory `data_ensemble/` containing 1,000 CSVs, each one a plausible realization of the true dataset.
    * DVC tracks the entire directory. `dvc repro` will re-generate the entire ensemble if an input changes.

**Engineering Sprint:**
* Take the DVC pipeline from Module 8.
* Modify the `process.py` script: instead of outputting a single CSV, it should now perform a Monte Carlo simulation for a calculated property and output an ensemble of 100 CSVs.
* Update the `dvc.yaml` file to track the output directory.
* Run `dvc repro` and verify that the ensemble is created and tracked correctly.

---

### **Hour 13-14: Communicating Uncertainty: Beyond the Error Bar** üìä

**Learning Objectives:**
* Create effective visualizations that communicate uncertainty to non-experts.
* Differentiate between confidence intervals and prediction intervals.
* Generate "probability of exceedance" maps and charts for decision support.

**Content:**
* **Visualizing Distributions**: Moving beyond simple error bars to more informative plots like violin plots, gradient plots, and spaghetti plots (for time series or spatial ensembles).
* **Confidence vs. Prediction Intervals**:
    * **Confidence Interval**: "We are 95% confident that the true mean value lies within this range."
    * **Prediction Interval**: "We are 95% confident that the *next measurement* will fall within this (wider) range."
* **Decision Support**: The most powerful use of uncertainty. Instead of asking "What is the carbon stock?", we ask "What is the probability the carbon stock is above the threshold for selling credits?". This is calculated directly from the output of a Monte Carlo simulation.

**Visualization Workshop:**
* Using the carbon stock ensemble from the Hour 5-6 lab:
    1.  Create a histogram and a violin plot of the output distribution.
    2.  Calculate and report the 95% confidence interval.
    3.  Calculate and report the probability that the carbon stock is greater than a specific target value (e.g., 50 Mg/ha).

---

### **Hour 15: Capstone: A Fully Probabilistic Soil Carbon Audit** üèÜ

**Final Challenge:**
You are given a heterogeneous dataset for a single farm, compiled from two different commercial labs. The dataset includes soil carbon, bulk density, and detection limit flags for a heavy metal contaminant. One lab is known to have a slight positive bias from a ring trial. Your task is to perform a complete, end-to-end probabilistic analysis to determine the farm's carbon stock and assess if the contaminant exceeds a regulatory threshold.

**Your Pipeline Must:**
1.  **Ingest & Model Uncertainty**: Read the data. For each measurement, create a statistical distribution that accounts for analytical precision.
2.  **Handle Censored Data**: Use Regression on Order Statistics (ROS) to properly handle the BDL values for the contaminant.
3.  **Correct for Bias**: Apply a correction to the data from the biased lab, incorporating the uncertainty of that correction.
4.  **Propagate Uncertainty**: Use a Monte Carlo simulation (with at least 10,000 iterations) to propagate all sources of uncertainty through the carbon stock calculation.
5.  **Deliver Probabilistic Intelligence**: Produce a final report that includes:
    * The farm's total carbon stock, reported as a mean and a 95% confidence interval.
    * A histogram visualizing the final distribution of the carbon stock.
    * The estimated mean concentration of the contaminant, with its confidence interval.
    * A clear statement of the **probability** that the contaminant concentration exceeds the regulatory threshold.

**Deliverables:**
* A fully documented script or Jupyter Notebook that executes the entire probabilistic workflow.
* The final report in markdown format, presenting the results and visualizations in a clear, understandable way for a non-statistician (e.g., the farm manager).

**Assessment Criteria:**
* Correct implementation of all statistical methods (censored data, bias correction, Monte Carlo).
* The robustness and reproducibility of the code.
* The clarity and correctness of the final report and visualizations.
* The ability to translate complex statistical outputs into actionable, probability-based statements for decision-making.